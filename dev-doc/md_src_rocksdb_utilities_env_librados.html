<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>autotier: Introduce to EnvLibrados</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">autotier
   </div>
   <div id="projectbrief">Automatic Tiering Fuse Filesystem</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Introduce to EnvLibrados </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>EnvLibrados is a customized RocksDB Env to use RADOS as the backend file system of RocksDB. It overrides all file system related API of default Env. The easiest way to use it is just like following: </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line">std::string db_name = &quot;test_db&quot;;</div>
<div class="line">std::string config_path = &quot;path/to/ceph/config&quot;;</div>
<div class="line">DB* db;</div>
<div class="line">Options options;</div>
<div class="line">options.env = EnvLibrados(db_name, config_path);</div>
<div class="line">Status s = DB::Open(options, kDBPath, &amp;db);</div>
<div class="line">...</div>
</div><!-- fragment --><p>Then EnvLibrados will forward all file read/write operation to the RADOS cluster assigned by config_path. Default pool is db_name+"_pool".</p>
<h1><a class="anchor" id="autotoc_md888"></a>
Options for EnvLibrados</h1>
<p>There are some options that users could set for EnvLibrados.</p><ul>
<li>write_buffer_size. This variable is the max buffer size for WritableFile. After reaching the buffer_max_size, EnvLibrados will sync buffer content to RADOS, then clear buffer.</li>
<li>db_pool. Rather than using default pool, users could set their own db pool name</li>
<li>wal_dir. The dir for WAL files. Because RocksDB only has 2-level structure (dir_name/file_name), the format of wal_dir is "/dir_name"(CAN'T be "/dir1/dir2"). Default wal_dir is "/wal".</li>
<li>wal_pool. Corresponding pool name for WAL files. Default value is db_name+"_wal_pool"</li>
</ul>
<p>The example of setting options looks like following: </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line">db_name = &quot;test_db&quot;;</div>
<div class="line">db_pool = db_name+&quot;_pool&quot;;</div>
<div class="line">wal_dir = &quot;/wal&quot;;</div>
<div class="line">wal_pool = db_name+&quot;_wal_pool&quot;;</div>
<div class="line">write_buffer_size = 1 &lt;&lt; 20;</div>
<div class="line">env_ = new EnvLibrados(db_name, config, db_pool, wal_dir, wal_pool, write_buffer_size);</div>
<div class="line"> </div>
<div class="line">DB* db;</div>
<div class="line">Options options;</div>
<div class="line">options.env = env_;</div>
<div class="line">// The last level dir name should match the dir name in prefix_pool_map</div>
<div class="line">options.wal_dir = &quot;/tmp/wal&quot;;                    </div>
<div class="line"> </div>
<div class="line">// open DB</div>
<div class="line">Status s = DB::Open(options, kDBPath, &amp;db);</div>
<div class="line">...</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md889"></a>
Performance Test</h1>
<h2><a class="anchor" id="autotoc_md890"></a>
Compile</h2>
<p>Check this <a href="https://github.com/facebook/rocksdb/blob/main/INSTALL.md">link</a> to install the dependencies of RocksDB. Then you can compile it by running <code>$ make env_librados_test ROCKSDB_USE_LIBRADOS=1</code> under <code>rocksdb\</code>. The configure file used by env_librados_test is <code>../ceph/src/ceph.conf</code>. For Ubuntu 14.04, just run following commands: </p><div class="fragment"><div class="line">$ sudo apt-get install libgflags-dev</div>
<div class="line">$ sudo apt-get install libsnappy-dev</div>
<div class="line">$ sudo apt-get install zlib1g-dev</div>
<div class="line">$ sudo apt-get install libbz2-dev</div>
<div class="line">$ make env_librados_test ROCKSDB_USE_LIBRADOS=1</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md891"></a>
Test Result</h2>
<p>My test environment is Ubuntu 14.04 in VirtualBox with 8 cores and 8G RAM. Following is the test result.</p>
<ol type="1">
<li>Write (1&lt;&lt;20) keys in random order. The time of writing under default env is around 10s while the time of writing under EnvLibrados is varying from 10s to 30s.</li>
<li>Write (1&lt;&lt;20) keys in sequential order. The time of writing under default env drops to arround 1s. But the time of writing under EnvLibrados is not changed.</li>
<li>Read (1&lt;&lt;16) keys from (1&lt;&lt;20) keys in random order. The time of reading under both Envs are roughly the same, around 1.8s.</li>
</ol>
<h1><a class="anchor" id="autotoc_md892"></a>
MyRocks Test</h1>
<h2><a class="anchor" id="autotoc_md893"></a>
Compile Ceph</h2>
<p>See <a href="http://docs.ceph.com/docs/master/install/build-ceph/">link</a></p>
<h2><a class="anchor" id="autotoc_md894"></a>
Start RADOS</h2>
<div class="fragment"><div class="line">cd ceph-path/src</div>
<div class="line">( ( ./stop.sh; rm -rf dev/*; CEPH_NUM_OSD=3 ./vstart.sh --short --localhost -n</div>
<div class="line">-x -d ; ) ) 2&gt;&amp;1</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md895"></a>
Compile MySQL</h2>
<div class="fragment"><div class="line">sudo apt-get update</div>
<div class="line">sudo apt-get install g++ cmake libbz2-dev libaio-dev bison \</div>
<div class="line">zlib1g-dev libsnappy-dev </div>
<div class="line">sudo apt-get install libgflags-dev libreadline6-dev libncurses5-dev \</div>
<div class="line">libssl-dev liblz4-dev gdb git</div>
<div class="line"> </div>
<div class="line">git clone https://github.com/facebook/mysql-5.6.git</div>
<div class="line">cd mysql-5.6</div>
<div class="line">git submodule init</div>
<div class="line">git submodule update</div>
<div class="line">cmake . -DCMAKE_BUILD_TYPE=RelWithDebInfo -DWITH_SSL=system \</div>
<div class="line">-DWITH_ZLIB=bundled -DMYSQL_MAINTAINER_MODE=0 -DENABLED_LOCAL_INFILE=1 -DROCKSDB_USE_LIBRADOS=1</div>
<div class="line">make install -j8</div>
</div><!-- fragment --><p>Check this <a href="https://github.com/facebook/mysql-5.6/wiki/Build-Steps">link</a> for latest compile steps.</p>
<h2><a class="anchor" id="autotoc_md896"></a>
Configure MySQL</h2>
<p>Following is the steps of configuration of MySQL.</p>
<div class="fragment"><div class="line">mkdir -p /etc/mysql</div>
<div class="line">mkdir -p /var/lib/mysql</div>
<div class="line">mkdir -p /etc/mysql/conf.d</div>
<div class="line">echo -e &#39;[mysqld_safe]\nsyslog&#39; &gt; /etc/mysql/conf.d/mysqld_safe_syslog.cnf</div>
<div class="line">cp /usr/share/mysql/my-medium.cnf /etc/mysql/my.cnf</div>
<div class="line">sed -i &#39;s#.*datadir.*#datadir = /var/lib/mysql#g&#39; /etc/mysql/my.cnf</div>
<div class="line">chown mysql:mysql -R /var/lib/mysql</div>
<div class="line"> </div>
<div class="line">mysql_install_db --user=mysql --ldata=/var/lib/mysql/</div>
<div class="line">export CEPH_CONFIG_PATH=&quot;path/of/ceph/config/file&quot;</div>
<div class="line">mysqld_safe -user=mysql --skip-innodb --rocksdb --default-storage-engine=rocksdb --default-tmp-storage-engine=MyISAM &amp;</div>
<div class="line">mysqladmin -u root password</div>
<div class="line">mysql -u root -p</div>
</div><!-- fragment --><p>Check this <a href="https://gist.github.com/shichao-an/f5639ecd551496ac2d70">link</a> for detail information.</p>
<div class="fragment"><div class="line">show databases;</div>
<div class="line"><span class="keyword">create</span> database testdb;</div>
<div class="line">use testdb;</div>
<div class="line">show tables;</div>
<div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tbl (id <span class="keywordtype">INT</span> AUTO_INCREMENT <span class="keyword">primary</span> key, str <span class="keywordtype">VARCHAR</span>(<span class="stringliteral">32</span>));</div>
<div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tbl <span class="keyword">values</span> (<span class="stringliteral">1</span>, <span class="stringliteral">&quot;val2&quot;</span>);</div>
<div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tbl;</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
