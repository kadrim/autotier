<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>autotier: How RocksDB Options and their Java Wrappers Work</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">autotier
   </div>
   <div id="projectbrief">Automatic Tiering Fuse Filesystem</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">How RocksDB Options and their Java Wrappers Work </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Options in RocksDB come in many different flavours. This is an attempt at a taxonomy and explanation.</p>
<h1><a class="anchor" id="autotoc_md808"></a>
RocksDB Options</h1>
<p>Initially, I believe, RocksDB had only database options. I don't know if any of these were mutable. Column families came later. Read on to understand the terminology.</p>
<p>So to begin, one sets up a collection of options and starts/creates a database with these options. That's a useful way to think about it, because from a Java point-of-view (and I didn't realise this initially and got very confused), despite making native calls to C++, the <code>API</code>s are just manipulating a native C++ configuration object. This object is just a record of configuration, and it must later be passed to the database (at create or open time) in order to apply the options.</p>
<h2><a class="anchor" id="autotoc_md809"></a>
Database versus Column Family</h2>
<p>The concept of the <em>column family</em> or <code>CF</code> is widespread within RocksDB. I think of it as a data namespace, but conveniently transactions can operate across these namespaces. The concept of a default column family exists, and when operations do not refer to a particular <code>CF</code>, it refers to the default.</p>
<p>We raise this w.r.t. options because many options, perhaps most that users encounter, are <em>column family options</em>. That is to say they apply individually to a particular column family, or to the default column family. Crucially also, many/most/all of these same options are exposed as <em>database options</em> and then apply as the default for column families which do not have the option set explicitly. Obviously some database options are naturally database-wide; they apply to the operation of the database and don't make any sense applied to a column family.</p>
<h2><a class="anchor" id="autotoc_md810"></a>
Mutability</h2>
<p>There are 2 kinds of options</p>
<ul>
<li>Mutable options</li>
<li>Immutable options. We name these in contrast to the mutable ones, but they are usually referred to unqualified.</li>
</ul>
<p>Mutable options are those which can be changed on a running <code>RocksDB</code> instance. Immutable options can only be configured prior to the start of a database. Of course, we can configure the immutable options at this time too; The entirety of options is a strict superset of the mutable options.</p>
<p>Mutable options (whether column-family specific or database-wide) are manipulated at runtime with builders, so we have <code>MutableDBOptions.MutableDBOptionsBuilder</code> and <code>MutableColumnFamilyOptions.MutableColumnFamilyOptionsBuilder</code> which share tooling classes/hierarchy and maintain and manipulate the relevant options as a <code>(key,value)</code> map.</p>
<p>Mutable options are then passed using <code>setOptions()</code> and <code>setDBOptions()</code> methods on the live RocksDB, and then take effect immediately (depending on the semantics of the option) on the database.</p>
<h2><a class="anchor" id="autotoc_md811"></a>
Advanced</h2>
<p>There are 2 classes of options</p>
<ul>
<li>Advanced options</li>
<li>Non-advanced options</li>
</ul>
<p>It's not clear to me what the conceptual distinction is between advanced and not. However, the Java code takes care to reflect it from the underlying C++.</p>
<p>This leads to 2 separate type hierarchies within column family options, one for each <code>class</code> of options. The <code>kind</code>s are represented by where the options appear in their hierarchy.</p>
<div class="fragment"><div class="line"><span class="keyword">interface </span>ColumnFamilyOptionsInterface&lt;T <span class="keyword">extends</span> ColumnFamilyOptionsInterface&lt;T&gt;&gt;</div>
<div class="line">    extends AdvancedColumnFamilyOptionsInterface&lt;T&gt;</div>
<div class="line">interface MutableColumnFamilyOptionsInterface&lt;T extends MutableColumnFamilyOptionsInterface&lt;T&gt;&gt;</div>
<div class="line">    extends AdvancedMutableColumnFamilyOptionsInterface&lt;T&gt;</div>
</div><!-- fragment --><p>And then there is ultimately a single concrete implementation class for CF options:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>ColumnFamilyOptions <span class="keyword">extends</span> RocksObject</div>
<div class="line">    implements ColumnFamilyOptionsInterface&lt;ColumnFamilyOptions&gt;,</div>
<div class="line">    MutableColumnFamilyOptionsInterface&lt;ColumnFamilyOptions&gt;</div>
</div><!-- fragment --><p>as there is a single concrete implementation class for DB options:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>DBOptions <span class="keyword">extends</span> RocksObject</div>
<div class="line">    implements DBOptionsInterface&lt;DBOptions&gt;,</div>
<div class="line">    MutableDBOptionsInterface&lt;DBOptions&gt;</div>
</div><!-- fragment --><p>Interestingly <code>DBOptionsInterface</code> doesn't extend <code>MutableDBOptionsInterface</code>, if only in order to disrupt our belief in consistent basic laws of the Universe.</p>
<h1><a class="anchor" id="autotoc_md812"></a>
Startup/Creation Options</h1>
<div class="fragment"><div class="line"><span class="keyword">class </span>Options <span class="keyword">extends</span> RocksObject</div>
<div class="line">    implements DBOptionsInterface&lt;Options&gt;,</div>
<div class="line">    MutableDBOptionsInterface&lt;Options&gt;,</div>
<div class="line">    ColumnFamilyOptionsInterface&lt;Options&gt;,</div>
<div class="line">    MutableColumnFamilyOptionsInterface&lt;Options&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md813"></a>
Example - Blob Options</h2>
<p>The <code>enable_blob_files</code> and <code>min_blob_size</code> options are per-column-family, and are mutable. The options also appear in the unqualified database options. So by initial configuration, we can set up a RocksDB database where for every <code>(key,value)</code> with a value of size at least <code>min_blob_size</code>, the value is written (indirected) to a blob file. Blobs may share a blob file, subject to the configuration values set. Later, using the <code>MutableColumnFamilyOptionsInterface</code> of the <code>ColumnFamilyOptions</code>, we can choose to turn this off (<code>enable_blob_files=false</code>) , or alter the <code>min_blob_size</code> for the default column family, or any other column family. It seems to me that we cannot, though, mutate the column family options for all column families using the <code>setOptions()</code> mechanism, either for all existing column families or for all future column families; but maybe we can do the latter on a re-&lsquo;open()/create()&rsquo; </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
